{% extends "base.html" %}

{% block title %}Add Medicine - TrackMedi{% endblock %}

{% block content %}
<div class="max-w-4xl mx-auto">
    <!-- Header -->
    <div class="bg-gradient-to-r from-purple-500 to-pink-500 text-white p-8 rounded-2xl shadow-lg mb-8">
        <div class="flex items-center">
            <i class="fas fa-plus-circle text-4xl mr-4"></i>
            <div>
                <h1 class="text-3xl font-bold mb-2">Add New Medicine</h1>
                <p class="text-purple-100">Add medicines to your tracking list</p>
            </div>
        </div>
    </div>

    <!-- Form -->
    <div class="bg-white rounded-xl shadow-lg p-8">
        <div class="mb-6 p-4 rounded-lg border border-dashed border-purple-400 bg-purple-50">
            <div class="flex items-center justify-between">
                <div class="flex items-center">
                    <i class="fas fa-file-medical text-purple-600 mr-2"></i>
                    <span class="font-medium text-purple-900">Upload Prescription (OCR)</span>
                </div>
                <div>
                    <input id="prescription_input_add" type="file" accept="image/*" style="display:none" onchange="handlePrescriptionUploadOnAdd(event)">
                    <button type="button" onclick="document.getElementById('prescription_input_add').click()" class="px-3 py-2 rounded bg-purple-600 text-white hover:bg-purple-700 text-sm">Choose Image</button>
                </div>
            </div>
            <div id="prescription_status_add" class="text-xs text-purple-700 mt-2" style="display:none"></div>
        </div>

        <form method="POST" action="/add_medicine" class="space-y-6">
            <div>
                <label class="block text-sm font-medium text-gray-700 mb-2">
                    <i class="fas fa-pills mr-2 text-purple-500"></i>Medicine Name
                </label>
                <input type="text" name="med_name" id="med_name" required 
                       class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-purple-500 focus:border-transparent transition-all"
                       placeholder="Start typing medicine name...">
                <div id="medicine_suggestions" class="mt-2 bg-white border border-gray-300 rounded-lg shadow-lg max-h-60 overflow-y-auto" style="display: none;"></div>
            </div>
            
            <div>
                <label class="block text-sm font-medium text-gray-700 mb-2">
                    <i class="fas fa-weight mr-2 text-purple-500"></i>Dosage/Strength
                </label>
                <input type="text" name="dosage" required 
                       class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-purple-500 focus:border-transparent transition-all"
                       placeholder="e.g., 500mg tablet, 2% cream, 10ml syrup, 1 drop">
                <p class="text-sm text-gray-500 mt-1">
                    <i class="fas fa-info-circle mr-1"></i>
                    For tablets: 500mg | For creams: 2% | For syrups: 10ml | For drops: 1 drop
                </p>
            </div>
            
            <div>
                <label class="block text-sm font-medium text-gray-700 mb-2">
                    <i class="fas fa-clock mr-2 text-purple-500"></i>Frequency
                </label>
                <select name="frequency" required 
                        class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-purple-500 focus:border-transparent transition-all">
                    <option value="">Select frequency</option>
                    <option value="once daily">Once Daily</option>
                    <option value="twice daily">Twice Daily</option>
                    <option value="three times daily">Three Times Daily</option>
                    <option value="every 8 hours">Every 8 Hours</option>
                    <option value="every 12 hours">Every 12 Hours</option>
                </select>
            </div>
            
            <div>
                <label class="block text-sm font-medium text-gray-700 mb-2">
                    <i class="fas fa-clock mr-2 text-purple-500"></i>Frequency
                </label>
                <select name="frequency" required 
                        class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-purple-500 focus:border-transparent transition-all">
                    <option value="">Select frequency</option>
                    <option value="once daily">Once Daily</option>
                    <option value="twice daily">Twice Daily</option>
                    <option value="three times daily">Three Times Daily</option>
                    <option value="every 8 hours">Every 8 Hours</option>
                    <option value="every 12 hours">Every 12 Hours</option>
                </select>
            </div>
            
            <div>
                <label class="block text-sm font-medium text-gray-700 mb-2">
                    <i class="fas fa-bell mr-2 text-purple-500"></i>Reminder Times
                </label>
                <div id="reminder-times">
                    <div class="reminder-time mb-2">
                        <input type="time" name="reminder_time_1" 
                               class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-purple-500 focus:border-transparent transition-all">
                    </div>
                </div>
                <button type="button" onclick="addReminderTime()" class="mt-2 text-purple-600 hover:text-purple-800 text-sm">
                    <i class="fas fa-plus mr-1"></i>Add Another Time
                </button>
                <p class="text-sm text-gray-500 mt-1">
                    <i class="fas fa-info-circle mr-1"></i>
                    Set specific times when you want to be reminded to take this medicine
                </p>
            </div>
            
            <div>
                <label class="block text-sm font-medium text-gray-700 mb-2">
                    <i class="fas fa-birthday-cake mr-2 text-purple-500"></i>Age Group
                </label>
                <select name="age_group" required 
                        class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-purple-500 focus:border-transparent transition-all">
                    <option value="">Select age group</option>
                    <option value="pediatric">Pediatric (0-17 years)</option>
                    <option value="adult">Adult (18-64 years)</option>
                    <option value="elderly">Elderly (65+ years)</option>
                </select>
            </div>
            
            <div>
                <label class="block text-sm font-medium text-gray-700 mb-2">
                    <i class="fas fa-stethoscope mr-2 text-purple-500"></i>Purpose (Optional)
                </label>
                <textarea name="purpose" rows="3"
                          class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-purple-500 focus:border-transparent transition-all"
                          placeholder="Why are you taking this medicine?"></textarea>
            </div>
            
            <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-2">
                        <i class="fas fa-weight mr-2 text-purple-500"></i>Weight (kg)
                    </label>
                    <input type="number" name="weight" step="0.1" min="1" max="300"
                           class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-purple-500 focus:border-transparent transition-all"
                           placeholder="e.g., 70.5">
                </div>
                
                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-2">
                        <i class="fas fa-ruler-vertical mr-2 text-purple-500"></i>Height (cm)
                    </label>
                    <input type="number" name="height" step="0.1" min="50" max="250"
                           class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-purple-500 focus:border-transparent transition-all"
                           placeholder="e.g., 175.0">
                </div>
            </div>
            
            <div>
                <label class="block text-sm font-medium text-gray-700 mb-2">
                    <i class="fas fa-venus-mars mr-2 text-purple-500"></i>Gender
                </label>
                <select name="gender" 
                        class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-purple-500 focus:border-transparent transition-all">
                    <option value="">Select gender (optional)</option>
                    <option value="male">Male</option>
                    <option value="female">Female</option>
                    <option value="other">Other</option>
                </select>
            </div>
            
            <div>
                <label class="block text-sm font-medium text-gray-700 mb-2">
                    <i class="fas fa-heartbeat mr-2 text-purple-500"></i>Medical Conditions (Optional)
                </label>
                <textarea name="medical_conditions" rows="2"
                          class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-purple-500 focus:border-transparent transition-all"
                          placeholder="e.g., Diabetes, Hypertension, etc."></textarea>
            </div>
            
            <div>
                <label class="block text-sm font-medium text-gray-700 mb-2">
                    <i class="fas fa-exclamation-triangle mr-2 text-purple-500"></i>Allergies (Optional)
                </label>
                <textarea name="allergies" rows="2"
                          class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-purple-500 focus:border-transparent transition-all"
                          placeholder="e.g., Penicillin, Sulfa drugs, etc."></textarea>
            </div>
            
            <button type="submit" 
                    class="w-full bg-gradient-to-r from-purple-500 to-pink-500 text-white py-3 rounded-lg hover:from-purple-600 hover:to-pink-600 transition-all transform hover:-translate-y-0.5 shadow-lg font-semibold">
                <i class="fas fa-plus mr-2"></i>Add Medicine
            </button>
        </form>
        
        <div class="text-center mt-6 space-x-4">
            <a href="/dashboard" class="text-purple-600 hover:text-purple-700 font-semibold transition-colors">
                <i class="fas fa-arrow-left mr-2"></i>Back to Dashboard
            </a>
            <button onclick="clearAllMedicines()" class="text-red-600 hover:text-red-700 font-semibold transition-colors">
                <i class="fas fa-trash mr-2"></i>Clear All Medicines
            </button>
        </div>
    </div>
</div>

<script>
document.getElementById('med_name').addEventListener('input', function() {
    const query = this.value;
    const suggestions = document.getElementById('medicine_suggestions');
    
    if (query.length < 2) {
        suggestions.style.display = 'none';
        return;
    }
    
    fetch(`/search_medicine?q=${encodeURIComponent(query)}`)
        .then(response => response.json())
        .then(data => {
            suggestions.innerHTML = '';
            if (data.length > 0) {
                data.forEach(med => {
                    const item = document.createElement('div');
                    item.className = 'px-4 py-3 hover:bg-purple-50 cursor-pointer border-b border-gray-100 last:border-b-0';
                    item.innerHTML = `
                        <div class="flex items-center">
                            <i class="fas fa-pills text-purple-500 mr-3"></i>
                            <div class="flex-1">
                                <div class="font-semibold text-gray-800">${med.medicine_name}</div>
                                <div class="text-sm text-gray-600">${med.form} - ${med.main_category}</div>
                                <div class="text-xs text-purple-600 mt-1">
                                    ${med.dosage_concentration ? 'Strength: ' + med.dosage_concentration : 'Check dosage'}
                                </div>
                            </div>
                        </div>
                    `;
                    item.onclick = () => {
                        document.getElementById('med_name').value = med.medicine_name;
                        // Auto-fill dosage if available
                        if (med.dosage_concentration) {
                            document.querySelector('input[name="dosage"]').value = med.dosage_concentration;
                        }
                        suggestions.style.display = 'none';
                    };
                    suggestions.appendChild(item);
                });
                suggestions.style.display = 'block';
            } else {
                suggestions.innerHTML = '<div class="px-4 py-3 text-gray-500 text-center">No medicines found</div>';
                suggestions.style.display = 'block';
            }
        })
        .catch(error => {
            console.error('Search error:', error);
            suggestions.style.display = 'none';
        });
});

document.addEventListener('click', function(e) {
    if (!e.target.closest('#med_name') && !e.target.closest('#medicine_suggestions')) {
        document.getElementById('medicine_suggestions').style.display = 'none';
    }
});

function clearAllMedicines() {
    if (confirm('Are you sure you want to clear all medicines? This action cannot be undone.')) {
        fetch('/clear_medicines', { method: 'POST' })
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    alert('All medicines cleared successfully!');
                    window.location.href = '/dashboard';
                } else {
                    alert('Error clearing medicines: ' + data.error);
                }
            })
            .catch(error => {
                console.error('Error:', error);
                alert('Error clearing medicines');
            });
    }
}

// Reminder time management
let reminderCount = 1;

function addReminderTime() {
    reminderCount++;
    const reminderTimes = document.getElementById('reminder-times');
    const newReminder = document.createElement('div');
    newReminder.className = 'reminder-time mb-2 flex items-center';
    newReminder.innerHTML = `
        <input type="time" name="reminder_time_${reminderCount}" 
               class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-purple-500 focus:border-transparent transition-all">
        <button type="button" onclick="removeReminderTime(this)" class="ml-2 text-red-500 hover:text-red-700">
            <i class="fas fa-trash"></i>
        </button>
    `;
    reminderTimes.appendChild(newReminder);
}

function removeReminderTime(button) {
    button.parentElement.remove();
}

// Auto-fill reminder times based on frequency
document.querySelector('select[name="frequency"]').addEventListener('change', function() {
    const frequency = this.value;
    const reminderTimes = document.getElementById('reminder-times');
    
    // Clear existing times
    reminderTimes.innerHTML = '';
    reminderCount = 0;
    
    // Add default times based on frequency
    if (frequency === 'once daily') {
        addReminderTimeWithValue('08:00');
    } else if (frequency === 'twice daily') {
        addReminderTimeWithValue('08:00');
        addReminderTimeWithValue('20:00');
    } else if (frequency === 'three times daily') {
        addReminderTimeWithValue('08:00');
        addReminderTimeWithValue('14:00');
        addReminderTimeWithValue('20:00');
    } else if (frequency === 'every 8 hours') {
        addReminderTimeWithValue('08:00');
        addReminderTimeWithValue('16:00');
        addReminderTimeWithValue('00:00');
    } else if (frequency === 'every 12 hours') {
        addReminderTimeWithValue('08:00');
        addReminderTimeWithValue('20:00');
    }
});

function addReminderTimeWithValue(timeValue) {
    reminderCount++;
    const reminderTimes = document.getElementById('reminder-times');
    const newReminder = document.createElement('div');
    newReminder.className = 'reminder-time mb-2 flex items-center';
    newReminder.innerHTML = `
        <input type="time" name="reminder_time_${reminderCount}" value="${timeValue}"
               class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-purple-500 focus:border-transparent transition-all">
        <button type="button" onclick="removeReminderTime(this)" class="ml-2 text-red-500 hover:text-red-700">
            <i class="fas fa-trash"></i>
        </button>
    `;
    reminderTimes.appendChild(newReminder);
}
</script>
<script>
// Prefill form from URL parameters (used after OCR)
document.addEventListener('DOMContentLoaded', function() {
    const params = new URLSearchParams(window.location.search);
    const setIf = (selector, val) => { if (val) { const el = document.querySelector(selector); if (el) el.value = val; } };

    setIf('#med_name', params.get('med_name'));
    setIf('input[name="dosage"]', params.get('dosage'));

    const frequency = params.get('frequency');
    if (frequency) {
        const selects = document.querySelectorAll('select[name="frequency"]');
        selects.forEach(sel => { sel.value = frequency; sel.dispatchEvent(new Event('change')); });
    }

    const ageGroup = params.get('age_group');
    if (ageGroup) {
        const ageSel = document.querySelector('select[name="age_group"]');
        if (ageSel) ageSel.value = ageGroup;
    }

    setIf('input[name="weight"]', params.get('weight'));
    setIf('input[name="height"]', params.get('height'));
    setIf('textarea[name="allergies"]', params.get('allergies'));
    setIf('textarea[name="purpose"]', params.get('purpose'));
    const gender = params.get('gender');
    if (gender) {
        const gSel = document.querySelector('select[name="gender"]');
        if (gSel) gSel.value = gender.toLowerCase();
    }
});

// Direct OCR upload on Add Medicine page (fills fields without redirect)
function handlePrescriptionUploadOnAdd(evt) {
    const file = evt.target.files && evt.target.files[0];
    if (!file) return;
    const statusEl = document.getElementById('prescription_status_add');
    statusEl.style.display = 'block';
    statusEl.textContent = 'Uploading and reading prescription...';

    const controller = new AbortController();
    const timeoutId = setTimeout(() => controller.abort('timeout'), 30000);

    const prepareImageBlob = (f) => new Promise((resolve) => {
        try {
            const url = URL.createObjectURL(f);
            const img = new Image();
            img.onload = () => {
                try {
                    const maxDim = 1600;
                    let w = img.naturalWidth || img.width;
                    let h = img.naturalHeight || img.height;
                    if (Math.max(w, h) > maxDim) {
                        const ratio = maxDim / Math.max(w, h);
                        w = Math.max(1, Math.floor(w * ratio));
                        h = Math.max(1, Math.floor(h * ratio));
                    }
                    const canvas = document.createElement('canvas');
                    canvas.width = w; canvas.height = h;
                    const ctx = canvas.getContext('2d');
                    ctx.drawImage(img, 0, 0, w, h);
                    canvas.toBlob((blob) => {
                        URL.revokeObjectURL(url);
                        resolve(blob || f);
                    }, 'image/jpeg', 0.85);
                } catch(_) {
                    URL.revokeObjectURL(url);
                    resolve(f);
                }
            };
            img.onerror = () => { URL.revokeObjectURL(url); resolve(f); };
            img.src = url;
        } catch(_) { resolve(f); }
    });

    prepareImageBlob(file).then((blob) => {
        const formData = new FormData();
        const uploadFile = (blob instanceof Blob) ? new File([blob], (file.name || 'prescription') + '.jpg') : file;
        formData.append('prescription', uploadFile);

        return fetch('/upload_prescription', { method: 'POST', body: formData, signal: controller.signal, cache: 'no-store' })
            .then(async r => {
                const raw = await r.text();
                let json;
                try { json = JSON.parse(raw); } catch (_) {
                    const snippet = raw ? raw.slice(0, 200) : '(no body)';
                    throw new Error(`HTTP ${r.status} ${r.statusText} - ${snippet}`);
                }
                if (!r.ok) throw new Error(json.error || `HTTP ${r.status}`);
                return json;
            });
    })
    .then(res => {
        if (!res.success) throw new Error(res.error || 'OCR failed');
        const d = res.details || {};

        const setIf = (selector, val) => { if (val) { const el = document.querySelector(selector); if (el) el.value = val; } };
        setIf('#med_name', d.med_name);
        setIf('input[name="dosage"]', d.dosage);

        if (d.frequency) {
            const selects = document.querySelectorAll('select[name="frequency"]');
            selects.forEach(sel => { sel.value = d.frequency; sel.dispatchEvent(new Event('change')); });
        }
        if (d.age_group) {
            const ageSel = document.querySelector('select[name="age_group"]');
            if (ageSel) ageSel.value = d.age_group;
        }
        setIf('input[name="weight"]', d.weight);
        setIf('input[name="height"]', d.height);
        setIf('textarea[name="allergies"]', d.allergies);
        setIf('textarea[name="purpose"]', d.purpose);
        if (d.gender) {
            const gSel = document.querySelector('select[name="gender"]');
            if (gSel) gSel.value = (d.gender || '').toLowerCase();
        }

        statusEl.textContent = 'âœ… Prescription details filled. Please verify and submit.';
    })
    .catch(err => {
        console.error(err);
        const msg = (err && err.name === 'AbortError') ? 'Request timed out. Please try a smaller image.' : (err.message || 'failed to read prescription');
        statusEl.textContent = 'Error: ' + msg;
        alert('OCR error: ' + msg);
    })
    .finally(() => {
        try { clearTimeout(timeoutId); } catch(_) {}
    });
}
</script>
{% endblock %}
