{% extends "base.html" %}

{% block title %}Add Medicine - TrackMedi{% endblock %}

{% block content %}
<div class="max-w-4xl mx-auto">
    <!-- Header -->
    <div class="bg-gradient-to-r from-purple-500 to-pink-500 text-white p-8 rounded-2xl shadow-lg mb-8">
        <div class="flex items-center">
            <i class="fas fa-plus-circle text-4xl mr-4"></i>
            <div>
                <h1 class="text-3xl font-bold mb-2">Add New Medicine</h1>
                <p class="text-purple-100">Add medicines to your tracking list</p>
            </div>
        </div>
    </div>

    <!-- Form -->
    <div class="bg-white rounded-xl shadow-lg p-8">
        <!-- Prescription Upload for Auto-Fill -->
        <div class="mb-6 p-4 border border-dashed border-purple-300 rounded-lg bg-purple-50">
            <div class="flex items-center justify-between">
                <div class="flex items-center">
                    <i class="fas fa-file-medical text-2xl text-purple-500 mr-3"></i>
                    <div>
                        <div class="font-semibold text-gray-800">Auto-fill from Prescription</div>
                        <div class="text-sm text-gray-600">Upload a clear photo of your printed prescription to extract medicine details</div>
                    </div>
                </div>
                <div>
                    <input id="prescription_file" type="file" accept="image/*,.jpg,.jpeg,.png" class="hidden" />
                    <button type="button" onclick="document.getElementById('prescription_file').click()" class="px-4 py-2 bg-white border border-purple-300 text-purple-700 rounded-lg hover:bg-purple-100">
                        <i class="fas fa-upload mr-2"></i>Select Image
                    </button>
                    <button type="button" id="extract_btn" class="ml-2 px-4 py-2 bg-gradient-to-r from-purple-500 to-pink-500 text-white rounded-lg hover:from-purple-600 hover:to-pink-600 disabled:opacity-50" disabled>
                        <i class="fas fa-magic mr-2"></i>Extract
                    </button>
                </div>
            </div>
            <div id="extract_status" class="text-sm text-gray-600 mt-3"></div>
        </div>
        <form method="POST" action="/add_medicine" class="space-y-6">
            <div>
                <label class="block text-sm font-medium text-gray-700 mb-2">
                    <i class="fas fa-pills mr-2 text-purple-500"></i>Medicine Name
                </label>
                <input type="text" name="med_name" id="med_name" required 
                       class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-purple-500 focus:border-transparent transition-all"
                       placeholder="Start typing medicine name...">
                <div id="medicine_suggestions" class="mt-2 bg-white border border-gray-300 rounded-lg shadow-lg max-h-60 overflow-y-auto" style="display: none;"></div>
            </div>
            
            <div>
                <label class="block text-sm font-medium text-gray-700 mb-2">
                    <i class="fas fa-weight mr-2 text-purple-500"></i>Dosage/Strength
                </label>
                <input type="text" name="dosage" required 
                       class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-purple-500 focus:border-transparent transition-all"
                       placeholder="e.g., 500mg tablet, 2% cream, 10ml syrup, 1 drop">
                <p class="text-sm text-gray-500 mt-1">
                    <i class="fas fa-info-circle mr-1"></i>
                    For tablets: 500mg | For creams: 2% | For syrups: 10ml | For drops: 1 drop
                </p>
            </div>
            
            <div>
                <label class="block text-sm font-medium text-gray-700 mb-2">
                    <i class="fas fa-clock mr-2 text-purple-500"></i>Frequency
                </label>
                <select name="frequency" required 
                        class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-purple-500 focus:border-transparent transition-all">
                    <option value="">Select frequency</option>
                    <option value="once daily">Once Daily</option>
                    <option value="twice daily">Twice Daily</option>
                    <option value="three times daily">Three Times Daily</option>
                    <option value="every 8 hours">Every 8 Hours</option>
                    <option value="every 12 hours">Every 12 Hours</option>
                </select>
            </div>
            
            <div>
                <label class="block text-sm font-medium text-gray-700 mb-2">
                    <i class="fas fa-bell mr-2 text-purple-500"></i>Reminder Times
                </label>
                <div id="reminder-times">
                    <div class="reminder-time mb-2">
                        <input type="time" name="reminder_time_1" 
                               class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-purple-500 focus:border-transparent transition-all">
                    </div>
                </div>
                <button type="button" onclick="addReminderTime()" class="mt-2 text-purple-600 hover:text-purple-800 text-sm">
                    <i class="fas fa-plus mr-1"></i>Add Another Time
                </button>
                <p class="text-sm text-gray-500 mt-1">
                    <i class="fas fa-info-circle mr-1"></i>
                    Set specific times when you want to be reminded to take this medicine
                </p>
            </div>
            
            <div>
                <label class="block text-sm font-medium text-gray-700 mb-2">
                    <i class="fas fa-birthday-cake mr-2 text-purple-500"></i>Age Group
                </label>
                <select name="age_group" required 
                        class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-purple-500 focus:border-transparent transition-all">
                    <option value="">Select age group</option>
                    <option value="pediatric">Pediatric (0-17 years)</option>
                    <option value="adult">Adult (18-64 years)</option>
                    <option value="elderly">Elderly (65+ years)</option>
                </select>
            </div>
            
            <div>
                <label class="block text-sm font-medium text-gray-700 mb-2">
                    <i class="fas fa-stethoscope mr-2 text-purple-500"></i>Purpose (Optional)
                </label>
                <textarea name="purpose" rows="3"
                          class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-purple-500 focus:border-transparent transition-all"
                          placeholder="Why are you taking this medicine?"></textarea>
            </div>
            
            <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-2">
                        <i class="fas fa-weight mr-2 text-purple-500"></i>Weight (kg)
                    </label>
                    <input type="number" name="weight" step="0.1" min="1" max="300"
                           class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-purple-500 focus:border-transparent transition-all"
                           placeholder="e.g., 70.5">
                </div>
                
                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-2">
                        <i class="fas fa-ruler-vertical mr-2 text-purple-500"></i>Height (cm)
                    </label>
                    <input type="number" name="height" step="0.1" min="50" max="250"
                           class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-purple-500 focus:border-transparent transition-all"
                           placeholder="e.g., 175.0">
                </div>
            </div>
            
            <div>
                <label class="block text-sm font-medium text-gray-700 mb-2">
                    <i class="fas fa-venus-mars mr-2 text-purple-500"></i>Gender
                </label>
                <select name="gender" 
                        class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-purple-500 focus:border-transparent transition-all">
                    <option value="">Select gender (optional)</option>
                    <option value="male">Male</option>
                    <option value="female">Female</option>
                    <option value="other">Other</option>
                </select>
            </div>
            
            <div>
                <label class="block text-sm font-medium text-gray-700 mb-2">
                    <i class="fas fa-heartbeat mr-2 text-purple-500"></i>Medical Conditions (Optional)
                </label>
                <textarea name="medical_conditions" rows="2"
                          class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-purple-500 focus:border-transparent transition-all"
                          placeholder="e.g., Diabetes, Hypertension, etc."></textarea>
            </div>
            
            <div>
                <label class="block text-sm font-medium text-gray-700 mb-2">
                    <i class="fas fa-exclamation-triangle mr-2 text-purple-500"></i>Allergies (Optional)
                </label>
                <textarea name="allergies" rows="2"
                          class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-purple-500 focus:border-transparent transition-all"
                          placeholder="e.g., Penicillin, Sulfa drugs, etc."></textarea>
            </div>
            
            <button type="submit" 
                    class="w-full bg-gradient-to-r from-purple-500 to-pink-500 text-white py-3 rounded-lg hover:from-purple-600 hover:to-pink-600 transition-all transform hover:-translate-y-0.5 shadow-lg font-semibold">
                <i class="fas fa-plus mr-2"></i>Add Medicine
            </button>
        </form>
        
        <div class="text-center mt-6 space-x-4">
            <a href="/dashboard" class="text-purple-600 hover:text-purple-700 font-semibold transition-colors">
                <i class="fas fa-arrow-left mr-2"></i>Back to Dashboard
            </a>
            <button onclick="clearAllMedicines()" class="text-red-600 hover:text-red-700 font-semibold transition-colors">
                <i class="fas fa-trash mr-2"></i>Clear All Medicines
            </button>
        </div>
    </div>
</div>

<script>
const fileInput = document.getElementById('prescription_file');
const extractBtn = document.getElementById('extract_btn');
const extractStatus = document.getElementById('extract_status');

fileInput.addEventListener('change', function() {
    extractBtn.disabled = !fileInput.files || fileInput.files.length === 0;
    if (fileInput.files && fileInput.files.length > 0) {
        extractStatus.textContent = `Selected: ${fileInput.files[0].name}`;
    }
});

extractBtn.addEventListener('click', function() {
    if (!fileInput.files || fileInput.files.length === 0) return;
    const formData = new FormData();
    formData.append('file', fileInput.files[0]);
    formData.append('engine', 'easyocr');
    extractStatus.textContent = 'Extracting text from image...';
    extractBtn.disabled = true;
    fetch('/extract_prescription', {
        method: 'POST',
        body: formData
    }).then(r => {
        if (!r.ok) {
            throw new Error(`Server error: ${r.status} ${r.statusText}`);
        }
        return r.json();
    })
      .then(res => {
        if (!res.success) {
            extractStatus.textContent = 'Extraction failed: ' + (res.error || 'Unknown error');
            extractBtn.disabled = false;
            return;
        }
        const data = res.data || {};
        const engine = res.engine ? ` (engine: ${res.engine})` : '';
        const warn = res.warning ? ` - ${res.warning}` : '';
        if (data.med_name) {
            document.getElementById('med_name').value = data.med_name;
        }
        if (data.dosage) {
            const dosageInput = document.querySelector('input[name="dosage"]');
            if (dosageInput && !dosageInput.value) dosageInput.value = data.dosage;
        }
        if (data.frequency) {
            const freqSelect = document.querySelector('select[name="frequency"]');
            if (freqSelect) freqSelect.value = data.frequency;
            const evt = new Event('change');
            freqSelect && freqSelect.dispatchEvent(evt);
        }
        if (data.time) {
            const reminderTimes = document.getElementById('reminder-times');
            if (reminderTimes) {
                reminderTimes.innerHTML = '';
                window.reminderCount = 0;
                if (typeof addReminderTimeWithValue === 'function') {
                    const to24h = (t) => {
                        try {
                            const m = t.match(/(\d{1,2}):(\d{2})\s*(AM|PM)/i);
                            if (!m) return '09:00';
                            let hh = parseInt(m[1], 10);
                            const mm = m[2];
                            const ap = m[3].toUpperCase();
                            if (ap === 'PM' && hh !== 12) hh += 12;
                            if (ap === 'AM' && hh === 12) hh = 0;
                            return String(hh).padStart(2, '0') + ':' + mm;
                        } catch { return '09:00'; }
                    };
                    addReminderTimeWithValue(to24h(data.time));
                }
            }
        }
        if (data.purpose) {
            const purpose = document.querySelector('textarea[name="purpose"]');
            if (purpose && !purpose.value) purpose.value = data.purpose;
        }
        if (data.weight) {
            const weight = document.querySelector('input[name="weight"]');
            if (weight && !weight.value) weight.value = data.weight;
        }
        if (data.height) {
            const height = document.querySelector('input[name="height"]');
            if (height && !height.value) height.value = data.height;
        }
        if (data.allergies) {
            const allergies = document.querySelector('textarea[name="allergies"]');
            if (allergies && !allergies.value) allergies.value = data.allergies;
        }
        if (data.age_group) {
            const ag = document.querySelector('select[name="age_group"]');
            if (ag) ag.value = data.age_group;
        }
        extractStatus.textContent = 'Extraction complete. Review and submit' + engine + warn + '.';
        extractBtn.disabled = false;
      })
      .catch(err => {
        console.error('Extraction error:', err);
        extractStatus.textContent = 'Extraction error: ' + (err.message || 'Server not responding. Make sure Flask server is running.');
        extractBtn.disabled = false;
      });
});

document.getElementById('med_name').addEventListener('input', function() {
    const query = this.value;
    const suggestions = document.getElementById('medicine_suggestions');
    
    if (query.length < 2) {
        suggestions.style.display = 'none';
        return;
    }
    
    fetch(`/search_medicine?q=${encodeURIComponent(query)}`)
        .then(response => response.json())
        .then(data => {
            suggestions.innerHTML = '';
            if (data.length > 0) {
                data.forEach(med => {
                    const item = document.createElement('div');
                    item.className = 'px-4 py-3 hover:bg-purple-50 cursor-pointer border-b border-gray-100 last:border-b-0';
                    item.innerHTML = `
                        <div class="flex items-center">
                            <i class="fas fa-pills text-purple-500 mr-3"></i>
                            <div class="flex-1">
                                <div class="font-semibold text-gray-800">${med.medicine_name}</div>
                                <div class="text-sm text-gray-600">${med.form} - ${med.main_category}</div>
                                <div class="text-xs text-purple-600 mt-1">
                                    ${med.dosage_concentration ? 'Strength: ' + med.dosage_concentration : 'Check dosage'}
                                </div>
                            </div>
                        </div>
                    `;
                    item.onclick = () => {
                        document.getElementById('med_name').value = med.medicine_name;
                        // Auto-fill dosage if available
                        if (med.dosage_concentration) {
                            document.querySelector('input[name="dosage"]').value = med.dosage_concentration;
                        }
                        suggestions.style.display = 'none';
                    };
                    suggestions.appendChild(item);
                });
                suggestions.style.display = 'block';
            } else {
                suggestions.innerHTML = '<div class="px-4 py-3 text-gray-500 text-center">No medicines found</div>';
                suggestions.style.display = 'block';
            }
        })
        .catch(error => {
            console.error('Search error:', error);
            suggestions.style.display = 'none';
        });
});

document.addEventListener('click', function(e) {
    if (!e.target.closest('#med_name') && !e.target.closest('#medicine_suggestions')) {
        document.getElementById('medicine_suggestions').style.display = 'none';
    }
});

function clearAllMedicines() {
    if (confirm('Are you sure you want to clear all medicines? This action cannot be undone.')) {
        fetch('/clear_medicines', { method: 'POST' })
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    alert('All medicines cleared successfully!');
                    window.location.href = '/dashboard';
                } else {
                    alert('Error clearing medicines: ' + data.error);
                }
            })
            .catch(error => {
                console.error('Error:', error);
                alert('Error clearing medicines');
            });
    }
}

// Reminder time management
let reminderCount = 1;

function addReminderTime() {
    reminderCount++;
    const reminderTimes = document.getElementById('reminder-times');
    const newReminder = document.createElement('div');
    newReminder.className = 'reminder-time mb-2 flex items-center';
    newReminder.innerHTML = `
        <input type="time" name="reminder_time_${reminderCount}" 
               class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-purple-500 focus:border-transparent transition-all">
        <button type="button" onclick="removeReminderTime(this)" class="ml-2 text-red-500 hover:text-red-700">
            <i class="fas fa-trash"></i>
        </button>
    `;
    reminderTimes.appendChild(newReminder);
}

function removeReminderTime(button) {
    button.parentElement.remove();
}

// Auto-fill reminder times based on frequency
document.querySelector('select[name="frequency"]').addEventListener('change', function() {
    const frequency = this.value;
    const reminderTimes = document.getElementById('reminder-times');
    
    // Clear existing times
    reminderTimes.innerHTML = '';
    reminderCount = 0;
    
    // Add default times based on frequency
    if (frequency === 'once daily') {
        addReminderTimeWithValue('08:00');
    } else if (frequency === 'twice daily') {
        addReminderTimeWithValue('08:00');
        addReminderTimeWithValue('20:00');
    } else if (frequency === 'three times daily') {
        addReminderTimeWithValue('08:00');
        addReminderTimeWithValue('14:00');
        addReminderTimeWithValue('20:00');
    } else if (frequency === 'every 8 hours') {
        addReminderTimeWithValue('08:00');
        addReminderTimeWithValue('16:00');
        addReminderTimeWithValue('00:00');
    } else if (frequency === 'every 12 hours') {
        addReminderTimeWithValue('08:00');
        addReminderTimeWithValue('20:00');
    }
});

function addReminderTimeWithValue(timeValue) {
    reminderCount++;
    const reminderTimes = document.getElementById('reminder-times');
    const newReminder = document.createElement('div');
    newReminder.className = 'reminder-time mb-2 flex items-center';
    newReminder.innerHTML = `
        <input type="time" name="reminder_time_${reminderCount}" value="${timeValue}"
               class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-purple-500 focus:border-transparent transition-all">
        <button type="button" onclick="removeReminderTime(this)" class="ml-2 text-red-500 hover:text-red-700">
            <i class="fas fa-trash"></i>
        </button>
    `;
    reminderTimes.appendChild(newReminder);
}
</script>
{% endblock %}
