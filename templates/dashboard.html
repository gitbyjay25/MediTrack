{% extends "base.html" %}

{% block title %}Dashboard - TrackMedi{% endblock %}

{% block content %}
<div class="w-full mx-0">
    <!-- Header Section -->
    <div class="bg-gradient-to-r from-purple-500 to-pink-500 text-white p-8 rounded-2xl shadow-lg mb-8">
        <div class="flex justify-between items-center">
            <div>
                <h1 class="text-3xl font-bold mb-2">Welcome to TrackMedi</h1>
                <p class="text-purple-100">Manage your medications intelligently</p>
            </div>
                  <div class="text-right">
                      <div class="bg-white/20 backdrop-blur-sm rounded-lg p-4">
                          <i class="fas fa-pills text-4xl mb-2 block"></i>
                          <p class="text-sm">Active Medicines</p>
                          <p class="text-2xl font-bold">{{ stats.total_medicines }}</p>
                      </div>
                  </div>
        </div>
    </div>

    <!-- Drug Interaction Alerts -->
    {% if interactions %}
    <div class="mb-6">
        {% for interaction in interactions %}
        <div class="bg-gradient-to-r from-red-100 to-orange-100 border-l-4 border-red-500 p-4 mb-3 rounded-r-lg shadow-sm" data-interaction="1" data-drug1="{{ interaction.drug1 }}" data-drug2="{{ interaction.drug2 }}" data-severity="{{ interaction.severity }}" data-timing="{{ interaction.timing_advice }}">
            <div class="flex items-center">
                <i class="fas fa-exclamation-triangle text-red-600 mr-3 text-xl"></i>
                <div class="flex-1">
                    <h4 class="text-red-800 font-semibold">
                        üö® Drug Interaction Alert: {{ interaction.drug1 }} + {{ interaction.drug2 }}
                    </h4>
                    <p class="text-red-700 text-sm mt-1">
                        <strong>Severity:</strong> {{ interaction.severity }} | 
                        <strong>Effect:</strong> {{ interaction.description[:100] }}{% if interaction.description|length > 100 %}...{% endif %}
                    </p>
                    {% if interaction.timing_advice %}
                    <div class="mt-3 p-3 bg-yellow-50 border border-yellow-200 rounded-lg">
                        <div class="flex items-start">
                            <i class="fas fa-clock text-yellow-600 mr-2 mt-1"></i>
                            <div>
                                <h5 class="text-yellow-800 font-semibold text-sm">‚è∞ Timing Recommendation:</h5>
                                <p class="text-yellow-700 text-sm mt-1">{{ interaction.timing_advice }}</p>
                            </div>
                        </div>
                    </div>
                    {% endif %}
                    {% if interaction.recommendation %}
                    <div class="mt-2 p-2 bg-blue-50 border border-blue-200 rounded">
                        <p class="text-blue-700 text-xs"><strong>Medical Advice:</strong> {{ interaction.recommendation }}</p>
                    </div>
                    {% endif %}
                </div>
            </div>
        </div>
        {% endfor %}
    </div>
    {% endif %}

    <div class="grid grid-cols-1 lg:grid-cols-3 gap-8">
        <!-- Main Content -->
        <div class="lg:col-span-2">
            <div class="">
                <div class="flex justify-between items-center mb-6">
                    <h2 class="text-2xl font-bold text-gray-800">Active Medicines</h2>
                    <a href="/add_medicine" class="px-6 py-2 rounded-lg border border-blue-500 text-blue-600 bg-white hover:bg-blue-50 transition-all shadow-sm">
                        <i class="fas fa-plus mr-2"></i>Add Medicine
                    </a>
                </div>
                
                {% if medicines %}
                    <div class="overflow-x-auto">
                        <table class="w-full">
                            <thead>
                                <tr class="border-b-2 border-purple-100">
                                    <th class="text-left py-3 px-4 font-semibold text-gray-700">Medicine</th>
                                    <th class="text-left py-3 px-4 font-semibold text-gray-700">Dosage</th>
                                    <th class="text-left py-3 px-4 font-semibold text-gray-700">Frequency</th>
                                    <th class="text-left py-3 px-4 font-semibold text-gray-700">Today's Doses</th>
                                    <th class="text-left py-3 px-4 font-semibold text-gray-700">Status</th>
                                    <th class="text-left py-3 px-4 font-semibold text-gray-700">Actions</th>
                                </tr>
                            </thead>
                            <tbody>
                                {% for medicine in medicines %}
                                <tr class="border-b border-gray-200 hover:bg-gray-50 transition-colors" data-med-id="{{ medicine.id }}" data-reminder-times="{{ medicine.reminder_times or '' }}">
                                          <td class="py-4 px-4">
                                              <div class="flex items-center">
                                                  <i class="fas fa-pills text-purple-500 mr-3"></i>
                                                  <span class="font-medium text-gray-800">{{ medicine.medicine_name }}</span>
                                              </div>
                                          </td>
                                          <td class="py-4 px-4 text-gray-600">{{ medicine.dosage }}</td>
                                          <td class="py-4 px-4 text-gray-600">{{ medicine.frequency }}</td>
                                          <td class="py-4 px-4">
                                              <span class="px-3 py-1 rounded-full text-sm font-medium {% if medicine.dose_status == 'Complete' %}bg-green-100 text-green-800{% elif medicine.dose_status == 'Not Taken' %}bg-red-100 text-red-800{% else %}bg-yellow-100 text-yellow-800{% endif %}">
                                                  {{ medicine.dose_status }}
                                              </span>
                                          </td>
                                          <td class="py-4 px-4">
                                              <span class="px-3 py-1 rounded-full text-sm font-medium {% if medicine.adherence_score >= 80 %}bg-green-100 text-green-800{% elif medicine.adherence_score >= 60 %}bg-yellow-100 text-yellow-800{% else %}bg-red-100 text-red-800{% endif %}">
                                                  {{ medicine.adherence_score }}%
                                              </span>
                                          </td>
                                          <td class="py-4 px-4">
                                              <div class="flex space-x-2">
                                                  <button onclick="takeMedicine({{ medicine.id }})" class="px-3 py-1 rounded border border-gray-300 text-gray-700 bg-white hover:bg-gray-50 text-sm">Take</button>
                                                  <button onclick="missMedicine({{ medicine.id }})" class="px-3 py-1 rounded border border-gray-300 text-gray-700 bg-white hover:bg-gray-50 text-sm">Miss</button>
                                                  <button onclick="removeMedicine({{ medicine.id }})" class="px-3 py-1 rounded border border-gray-300 text-gray-700 bg-white hover:bg-gray-50 text-sm">Remove</button>
                                                  {% if medicine.reminder_times %}
                                                  <button onclick="toggleReminder({{ medicine.id }})" class="px-3 py-1 rounded border border-gray-300 text-gray-700 bg-white hover:bg-gray-50 text-sm">Reminder</button>
                                                  <button onclick="rescheduleReminder({{ medicine.id }})" class="px-3 py-1 rounded border border-gray-300 text-gray-700 bg-white hover:bg-gray-50 text-sm">Snooze</button>
                                                  {% endif %}
                                              </div>
                                          </td>
                                </tr>
                                {% endfor %}
                            </tbody>
                        </table>
                    </div>
                {% else %}
                    <div class="text-center py-12">
                        <i class="fas fa-pills text-6xl text-gray-300 mb-4"></i>
                        <h3 class="text-xl font-semibold text-gray-600 mb-2">No Active Medicines</h3>
                        <p class="text-gray-500 mb-6">Start by adding your first medicine</p>
                        <a href="/add_medicine" class="bg-gradient-to-r from-purple-500 to-pink-500 text-white px-6 py-3 rounded-lg hover:from-purple-600 hover:to-pink-600 transition-all transform hover:-translate-y-0.5 shadow-lg">
                            <i class="fas fa-plus mr-2"></i>Add Medicine
                        </a>
                    </div>
                {% endif %}
            </div>
        </div>
        
        <!-- Sidebar -->
        <div class="space-y-6">
            <!-- Quick Actions -->
            <div class="bg-white rounded-xl shadow-lg p-6">
                <h3 class="text-xl font-bold text-gray-800 mb-4">Quick Actions</h3>
                <div class="space-y-3">
                    <a href="/add_medicine" class="w-full p-3 rounded-lg border border-blue-500 bg-white text-black hover:bg-blue-50 transition-all shadow-sm flex items-center justify-center">
                        <i class="fas fa-plus mr-2 text-blue-600"></i>Add Medicine
                    </a>
                    <a href="/recommendations" class="w-full p-3 rounded-lg border border-blue-500 bg-white text-black hover:bg-blue-50 transition-all shadow-sm flex items-center justify-center">
                        <i class="fas fa-brain mr-2 text-blue-600"></i>AI Recommendations
                    </a>
                    <a href="/dosage_optimization" class="w-full p-3 rounded-lg border border-blue-500 bg-white text-black hover:bg-blue-50 transition-all shadow-sm flex items-center justify-center">
                        <i class="fas fa-chart-line mr-2 text-blue-600"></i>Dosage AI
                    </a>
                    <a href="/dashboard" class="w-full p-3 rounded-lg border border-blue-500 bg-white text-black hover:bg-blue-50 transition-all shadow-sm flex items-center justify-center">
                        <i class="fas fa-sync-alt mr-2 text-blue-600"></i>Refresh
                    </a>
                </div>
            </div>

            <!-- Stats Card -->
            <div class="bg-gradient-to-br from-purple-100 to-pink-100 rounded-xl shadow-lg p-6">
                <h3 class="text-xl font-bold text-gray-800 mb-4">Today's Stats</h3>
                      <div class="space-y-4">
                          <div class="flex justify-between items-center">
                              <span class="text-gray-600">Medicines Taken</span>
                              <span class="font-bold text-purple-600">{{ stats.taken_today }}/{{ stats.total_medicines }}</span>
                          </div>
                          <div class="flex justify-between items-center">
                              <span class="text-gray-600">Adherence Rate</span>
                              <span class="font-bold text-green-600">{{ "%.0f"|format(stats.avg_adherence or 0) }}%</span>
                          </div>
                          <div class="flex justify-between items-center">
                              <span class="text-gray-600">Next Dose</span>
                              <span class="font-bold text-blue-600">Soon</span>
                          </div>
                      </div>
            </div>

            <!-- ML Models Status -->
            <div class="bg-gradient-to-br from-blue-100 to-cyan-100 rounded-xl shadow-lg p-6">
                <h3 class="text-xl font-bold text-gray-800 mb-4">
                    <i class="fas fa-brain mr-2 text-blue-600"></i>AI Models Status
                </h3>
                <div class="space-y-3">
                    <div class="flex justify-between items-center">
                        <span class="text-sm text-gray-600">Drug Interactions</span>
                        <span class="inline-flex items-center px-2 py-1 rounded-full text-xs font-medium bg-green-100 text-green-800">
                            <i class="fas fa-check-circle mr-1"></i>97.4% Accuracy
                        </span>
                    </div>
                    <div class="flex justify-between items-center">
                        <span class="text-sm text-gray-600">Recommendations</span>
                        <span class="inline-flex items-center px-2 py-1 rounded-full text-xs font-medium bg-green-100 text-green-800">
                            <i class="fas fa-check-circle mr-1"></i>95.9% Accuracy
                        </span>
                    </div>
                    <div class="flex justify-between items-center">
                        <span class="text-sm text-gray-600">Dosage Optimization</span>
                        <span class="inline-flex items-center px-2 py-1 rounded-full text-xs font-medium bg-yellow-100 text-yellow-800">
                            <i class="fas fa-exclamation-triangle mr-1"></i>R¬≤: 0.399
                        </span>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<script>
function takeMedicine(medicineId) {
    fetch('/take_medicine', {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json',
        },
        body: JSON.stringify({medicine_id: medicineId})
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            if (data.is_complete) {
                alert(`‚úÖ All doses taken! (${data.doses_taken}/${data.total_required})`);
            } else {
                alert(`‚úÖ Dose taken! (${data.doses_taken}/${data.total_required})`);
            }
            location.reload();
        } else {
            alert('Error: ' + data.error);
        }
    })
    .catch(error => {
        console.error('Error:', error);
        alert('Error taking medicine');
    });
}

function missMedicine(medicineId) {
    if (confirm('Mark this medicine as missed?')) {
        fetch('/miss_medicine', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
            },
            body: JSON.stringify({medicine_id: medicineId})
        })
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                alert('Medicine marked as missed');
                location.reload();
            } else {
                alert('Error: ' + data.error);
            }
        })
        .catch(error => {
            console.error('Error:', error);
            alert('Error marking medicine as missed');
        });
    }
}

function removeMedicine(medicineId) {
    if (confirm('Are you sure you want to remove this medicine from your list? This action cannot be undone.')) {
        fetch('/remove_medicine', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
            },
            body: JSON.stringify({medicine_id: medicineId})
        })
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                alert('Medicine removed successfully!');
                location.reload();
            } else {
                alert('Error: ' + data.error);
            }
        })
        .catch(error => {
            console.error('Error:', error);
            alert('Error removing medicine');
        });
    }
}

// Reminder system
let reminderIntervals = {};

function toggleReminder(medicineId) {
    if (reminderIntervals[medicineId]) {
        // Stop reminder
        clearInterval(reminderIntervals[medicineId]);
        delete reminderIntervals[medicineId];
        alert('Reminder stopped for this medicine');
        try { localStorage.removeItem(`reminder_on_${medicineId}`); } catch(e) {}
    } else {
        // Start reminder
        try { unlockAudio(); } catch(e) {}
        startReminder(medicineId);
        alert('Reminder started for this medicine');
        try { localStorage.setItem(`reminder_on_${medicineId}`, '1'); } catch(e) {}
    }
}

const lastReminderFired = {};
let _audioCtx;
function unlockAudio() {
    try {
        if (!_audioCtx) _audioCtx = new (window.AudioContext || window.webkitAudioContext)();
        if (_audioCtx.state === 'suspended') _audioCtx.resume();
        const o = _audioCtx.createOscillator();
        const g = _audioCtx.createGain();
        g.gain.value = 0.0001; // inaudible unlock
        o.connect(g).connect(_audioCtx.destination);
        o.start();
        o.stop(_audioCtx.currentTime + 0.02);
    } catch(e) { /* ignore */ }
}

function startReminder(medicineId) {
    // Find the row for this medicine
    const medicineRow = document.querySelector(`tr[data-med-id='${medicineId}']`);
    if (!medicineRow) return;

    const medicineName = medicineRow.querySelector('td:first-child span').textContent;
    // Parse reminder times from data attribute; accept formats like 7:22, 07:22, 7 22, 07.22
    const normalizeTime = (s) => {
        const m = String(s).match(/(\d{1,2})\D?(\d{2})/);
        if (!m) return null;
        const hh = m[1].padStart(2,'0');
        const mm = m[2].padStart(2,'0');
        return `${hh}:${mm}`;
    };
    const times = (medicineRow.dataset.reminderTimes || '')
        .split(',')
        .map(t => normalizeTime(t))
        .filter(Boolean);

    // If no times configured, do nothing
    if (!times.length) return;

    const checkNow = () => {
        const now = new Date();
        const hh = now.getHours().toString().padStart(2, '0');
        const mm = now.getMinutes().toString().padStart(2, '0');
        const currentTime = `${hh}:${mm}`;

        if (times.includes(currentTime)) {
            const key = `${medicineId}-${currentTime}`;
            // Prevent duplicate notifications within the same minute
            if (lastReminderFired[key]) return;
            lastReminderFired[key] = true;
            setTimeout(() => { delete lastReminderFired[key]; }, 60000);

            showReminderNotification(medicineName, currentTime);
            try { playAlarmSound(); } catch (e) {}
        }
    };
    // Initial quick check and then every 15s
    checkNow();
    reminderIntervals[medicineId] = setInterval(checkNow, 15000);
}

function showReminderNotification(medicineName, time) {
    // Request notification permission
    if (Notification.permission === 'granted') {
        new Notification(`üíä Medicine Reminder`, {
            body: `Time to take ${medicineName} at ${time}`,
            icon: '/static/favicon.ico',
            tag: 'medicine-reminder'
        });
    } else if (Notification.permission !== 'denied') {
        Notification.requestPermission().then(permission => {
            if (permission === 'granted') {
                showReminderNotification(medicineName, time);
            }
        });
    }
}

function rescheduleReminder(medicineId) {
    try { unlockAudio(); } catch(e) {}
    const minutesStr = prompt('Snooze for how many minutes?', '10');
    const minutes = parseInt(minutesStr, 10);
    if (isNaN(minutes) || minutes <= 0) return;

    const now = new Date();
    const target = new Date(now.getTime() + minutes * 60000);
    const hh = target.getHours().toString().padStart(2, '0');
    const mm = target.getMinutes().toString().padStart(2, '0');
    const newTime = `${hh}:${mm}`;

    // Attach/append to row data and persist for session
    const row = document.querySelector(`tr[data-med-id='${medicineId}']`);
    if (!row) return;
    const times = (row.dataset.reminderTimes || '').split(',').map(t => t.trim()).filter(Boolean);
    times.push(newTime);
    row.dataset.reminderTimes = Array.from(new Set(times)).join(',');
    try { localStorage.setItem(`snooze_${medicineId}`, newTime); } catch(e) {}

    // If running, restart interval to ensure immediate pickup
    if (reminderIntervals[medicineId]) {
        clearInterval(reminderIntervals[medicineId]);
        delete reminderIntervals[medicineId];
    }
    startReminder(medicineId);
    alert(`Reminder snoozed to ${newTime}`);
}

// Request notification permission on page load
document.addEventListener('DOMContentLoaded', function() {
    if (Notification.permission === 'default') {
        Notification.requestPermission();
    }

    // Auto-start reminders that were toggled on previously
    document.querySelectorAll('tr[data-med-id]').forEach(row => {
        const medId = row.dataset.medId;
        if (localStorage.getItem(`reminder_on_${medId}`)) {
            startReminder(medId);
        }
    });

    // One-time interaction notifications per page load
    try {
        const notifiedKey = 'interactions_notified_once';
        if (!sessionStorage.getItem(notifiedKey)) {
            const alerts = document.querySelectorAll('[data-interaction="1"]');
            alerts.forEach(a => {
                const drug1 = a.dataset.drug1;
                const drug2 = a.dataset.drug2;
                const severity = (a.dataset.severity || '').toLowerCase();
                const advice = a.dataset.timing || '';
                const title = `Interaction: ${drug1} + ${drug2}`;
                let body = `Severity: ${severity}`;
                if (advice) body += `\n${advice}`;
                try { showReminderNotification(title, body); } catch(e) {}
            });
            sessionStorage.setItem(notifiedKey, '1');
        }
    } catch(e) {}
});

// Play alarm sound for reminders
function playAlarmSound() {
    // Try custom mp3 first
    const sources = [
        '/assets/take_your_pills.mp3',
        'data:audio/wav;base64,UklGRnoGAABXQVZFZm10IBAAAAABAAEAQB8AAEAfAAABAAgAZGF0YQoGAACBhYqFbF1fdJivrJBhNjVgodDbq2EcBj+a2/LDciUFLIHO8tiJNwgZaLvt559NEAxQp+PwtmMcBjiR1/LMeSwFJHfH8N2QQAoUXrTp66hVFApGn+DyvmwhBSuBzvLZiTYIG2m98OScTgwOUarm7blmGgU7k9n1unEiBC13yO/eizEIHWq+8+OWT'
    ];
    const audio = new Audio();
    audio.src = sources[0];
    audio.onerror = () => { audio.src = sources[1]; audio.play().catch(()=>{}); };
    audio.play().catch(() => { try { unlockAudio(); audio.play(); } catch(e) {} });
}
</script>
{% endblock %}
